import wx
import requests
from helpers.logging.logger import Logger
from helpers.constants import ACCOUNT_FINAL_REPORT_PATH, SKIPPED_RECORDS_FILE_PATH, SOURCE_ACCOUNTS_GNRTD_PATH, ACCOUNTS_LOG_FILE_PATH
from Accounts.final_report_generator.report_generator import ReportGenerator
from Accounts.source_data_mapping.helper import Helper

class MyFrame(wx.Frame):
    def __init__(self, *args, **kw):
        super(MyFrame, self).__init__(*args, **kw)
        panel = wx.Panel(self)
        sizer = wx.BoxSizer(wx.VERTICAL)

        accounts_btn = wx.Button(panel, label="Accounts")
        sizer.Add(accounts_btn, 0, wx.ALL | wx.EXPAND, 5)

        accounts_btn.Bind(wx.EVT_BUTTON, self.on_accounts)

        panel.SetSizer(sizer)
        self.Show()

    def on_accounts(self, event):
        self.redirect_to_upload_section()

    def redirect_to_upload_section(self):
        upload_frame = wx.Frame(None, title="Upload Files", size=(400, 300))
        panel = wx.Panel(upload_frame)

        sizer = wx.BoxSizer(wx.VERTICAL)

        source_label = wx.StaticText(panel, label="Source File:")
        source_file_picker = wx.FilePickerCtrl(panel)
        sizer.Add(source_label, 0, wx.ALL, 5)
        sizer.Add(source_file_picker, 0, wx.ALL | wx.EXPAND, 5)

        target_label = wx.StaticText(panel, label="Target File:")
        target_file_picker = wx.FilePickerCtrl(panel)
        sizer.Add(target_label, 0, wx.ALL, 5)
        sizer.Add(target_file_picker, 0, wx.ALL | wx.EXPAND, 5)

        upload_btn = wx.Button(panel, label="Upload Files")
        sizer.Add(upload_btn, 0, wx.ALL | wx.CENTER, 5)

        upload_btn.Bind(wx.EVT_BUTTON, lambda event: self.upload_and_process_files(event, source_file_picker.GetPath(), target_file_picker.GetPath(), upload_frame))

        panel.SetSizer(sizer)
        upload_frame.Show()

    def upload_and_process_files(self, event, source_path, target_path, upload_frame):
        url = "http://127.0.0.1:8000/Accounts/upload/"
        files = {
            'sourcefile': open(source_path, 'rb'),
            'targetfile': open(target_path, 'rb')
        }
        
        try:
            response = requests.post(url, files=files)
            
            if response.status_code == 200:
                try:
                    message = response.json().get('message', 'No message returned')
                    # Call the main processing function after files are uploaded
                    self.main_processing_function()
                    upload_frame.Destroy()  # Close the upload window after processing
                    self.show_download_window()
                except requests.exceptions.JSONDecodeError:
                    message = 'Error: Received invalid JSON response'
            else:
                message = f'Error: Server returned status code {response.status_code}'
        except requests.exceptions.RequestException as e:
            message = f'Request failed: {e}'

        wx.MessageBox(message, "Information", wx.OK | wx.ICON_INFORMATION)

    def main_processing_function(self):
        '''Entry point of the accounts processing workflow'''
        try:
            logger = Logger(ACCOUNTS_LOG_FILE_PATH)
            helper = Helper()
            final_report_generator = ReportGenerator()
            gfx_input_data = helper.read_input(logger)
            mapped_records = helper.map_gfx_to_gpp(logger, gfx_input_data)
            helper.generate_target_file(logger, mapped_records)
            final_report_generator.process_dataframes(logger)
        except FileNotFoundError as e:
            logger.error(f"File not found: {e}")
        except IOError as e:
            logger.error(f"An unexpected error occurred while writing to the file: {e}")
        except Exception as e:
            logger.error(f"An unexpected error occurred: {e}")

    def show_download_window(self):
        self.download_count = 0
        self.total_files = 3

        self.download_frame = wx.Frame(None, title="Download Generated Files", size=(400, 300))
        panel = wx.Panel(self.download_frame)
        sizer = wx.BoxSizer(wx.VERTICAL)

        info_label = wx.StaticText(panel, label="Click the Download button to save the files:")
        sizer.Add(info_label, 0, wx.ALL, 10)

        generated_files = {
            "Final Report (Excel)": ACCOUNT_FINAL_REPORT_PATH,
            "Skipped Records (CSV)": SKIPPED_RECORDS_FILE_PATH,
            "SRC Accounts (DSV)": SOURCE_ACCOUNTS_GNRTD_PATH,
        }

        for file_label, file_path in generated_files.items():
            file_sizer = wx.BoxSizer(wx.HORIZONTAL)
            
            label = wx.StaticText(panel, label=file_label)
            file_sizer.Add(label, 1, wx.ALL | wx.EXPAND, 5)
            
            download_btn = wx.Button(panel, label="Download")
            file_sizer.Add(download_btn, 0, wx.ALL, 5)
            
            download_btn.Bind(wx.EVT_BUTTON, lambda event, path=file_path, label=file_label: self.download_file(event, path, label))
            
            sizer.Add(file_sizer, 0, wx.ALL | wx.EXPAND, 5)

        panel.SetSizer(sizer)
        self.download_frame.Show()

    def download_file(self, event, file_path, file_label):
        wildcard = ""
        if file_label.endswith("(Excel)"):
            wildcard = "Excel files (*.xlsx)|*.xlsx"
        elif file_label.endswith("(CSV)"):
            wildcard = "CSV files (*.csv)|*.csv"
        elif file_label.endswith("(DSV)"):
            wildcard = "DSV files (*.dsv)|*.dsv"
        
        save_dialog = wx.FileDialog(
            None, message=f"Save {file_label}", 
            defaultFile=file_path.split("/")[-1],
            wildcard=wildcard, 
            style=wx.FD_SAVE | wx.FD_OVERWRITE_PROMPT)
        
        if save_dialog.ShowModal() == wx.ID_OK:
            dest_path = save_dialog.GetPath()
            try:
                with open(file_path, 'rb') as src_file:
                    with open(dest_path, 'wb') as dest_file:
                        dest_file.write(src_file.read())
                wx.MessageBox(f"{file_label} saved successfully at {dest_path}", "Information", wx.OK | wx.ICON_INFORMATION)
                self.download_count += 1
                self.check_if_all_files_downloaded()
            except IOError as e:
                wx.MessageBox(f"Error saving {file_label}: {e}", "Error", wx.OK | wx.ICON_ERROR)
        
        save_dialog.Destroy()

    def check_if_all_files_downloaded(self):
        if self.download_count >= self.total_files:
            self.download_frame.Destroy()  # Close the download window
            self.Show()  # Redirect back to "My Application" window

def main():
    app = wx.App(False)
    frame = MyFrame(None, title="My Application", size=(400, 300))
    frame.Show(True)
    app.MainLoop()

if __name__ == "__main__":
    main()
